---
title: "Introduction-to-FINN"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction-to-FINN}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Introduction

FINN is an R-package of a forest gap model that seamlessly integrates with neural networks. The package provides various functions that allow the user to customize the model from a mechanistic forest gap model to a mostly data-driven neural network. Individual processes can be replaced by neural networks and custom functions can be incorporated, or a combination of both. The package is designed to be user-friendly and flexible, allowing users to easily modify the model.

# Installation

The development version of FINN can be installed from GitHub using the `devtools` package. Currently we are in a early stage of development and the package is not yet available on CRAN. If you encounter problems running the code or understanding the documentation, please let us know by opening an issue on the [GitHub repository](https://github.com/FINNverse/FINN).

```{r, eval = FALSE}
devtools::install_github("https://github.com/FINNverse/FINN")
```

# Run the model

Load the package and setup some basic simulation parameters.
```{r setup}
library(FINN)
library(data.table)
library(ggplot2)

Ntimesteps = 500  # number of timesteps
Nsites = 1 # number of sites
# one species
Nsp = 10 # number of species
```

## Species parameters

The user can specify the species parameters. For each process species parameters are stored in vectors or matrices with rows representing species and columns representing parameters. There are two kinds of parameters 
1) process parameters like light requirements and effect of size on a process. 
2) Environmental parameters that modulate the effect of the environment on a process. Environmental parameters also include an intercept that modulates the overall effect size of a process.


The following code generates random species parameters for a simple model with 10 species and 1 environmental variable.
```{r species-parameters1}
FINN.seed(1234)
# we draw the same shade parameters for each process for simplicity
# shade parameters correspond to the fraction of light a species needs to succesfully grow, regenerate, or survive.
shadeSP = runif(Nsp, 0.01, 0.99)

# regeneration parameters
parReg = shadeSP # regeneration is only dependent on shade and environment
parRegEnv = list(matrix(c(
  runif(Nsp, 1, 4), # intercept regulating the overall effect size
  runif(Nsp, -2, 2) # the second parameter modulates the effect of the environmental variable
  ),Nsp, 2))

# growth parameters
parGrowth = matrix(c(
  shadeSP, # see above
  runif(Nsp, 1, 2) # the second growth parameter modulates the size dependent growth
  ),Nsp, 2) 

parGrowthEnv = list(matrix(c(
  runif(Nsp, -1, 1), # intercept regulating the overall effect size
  runif(Nsp, -1, 1) # the second parameter modulates the effect of the environmental variable
  ),Nsp, 2))

# mortality parameters
parMort = matrix(c(
  shadeSP, # see above
  runif(Nsp, 1, 4) # the second growth parameter modulates the size dependent mortality
  ),Nsp, 2)
parMortEnv = list(matrix(c(
  runif(Nsp, 0, 0.5), # intercept regulating the overall effect size
  runif(Nsp, 0, .5) # the second parameter modulates the effect of the environmental variable
  ), Nsp, 2))

# allometric parameters for the calculation of tree height from a trees diameter
parHeight = runif(Nsp, 0.3, 0.7)
```

## Environment and disturbances

Next we have to specify the environmental input variables. These variables are used to calculate the effect of the environment on the processes. The environmental variables are supplied with a data.frame/data.table in a long format with the columns siteID and year and the environmental variables as additional columns.

```{r environmental-input}
# we first generate a data.table with all combinations of site and timestep.
env_dt <- data.table(
  expand.grid(
    list(
      siteID = 1:Nsites,
      year = 1:Ntimesteps
    )
  )
)

dist_dt <- env_dt

# for this very simple model we will have a constant environment for all sites and timesteps
env_dt$env1 = rep(0, Ntimesteps)

# we can also specify the intensity of disturbances for each timestep
disturbance_frequency = 0.2 # here we specify a disturbance frequency of 1%, which means that there is a 1% chance each year that a disturbance occurs
# the disturbance intensity at each timestep is the fraction of patches that is disturbed at that time step
disturbance_intensity = runif(Ntimesteps*Nsites, 0, 0.05) # here we draw a random number between 0 and 0.2 for each timestep and site
# this will result in 0 to 20 % of the patches being disturbed at each timestep with a change of 1% that a disturbance occurs at the timestep
dist_dt$intensity = dist_dt$intensity = rbinom(Ntimesteps*Nsites, 1, disturbance_frequency)*disturbance_intensity
```

## Simulate

The model can be run with the `simulateForest` function. Its arguments are `env` which is the environmental input data.table, `sp` the number of species, `patches` the number of patches, `height` the allometric parameters for the calculation of tree height, and the processes. 

The processes are specified with the `createProcess` function. The first argument is a formula that specifies the relation between environment and the process. The formula includes the intercept and the environmental variables that are provided with `env`. The second argument is the function that should be used for the process. FINN includes the default functions `growth`, `mortality`, and `regeneration`. The user can also provide custom functions, which is explained below.
The function should take the species parameters and the environmental parameters as arguments. The third and fourth arguments are the initial species and environmental parameters.

Disturbances can be specified with the `disturbance` argument, which requires a data.table with 

```{r simulate1, include = FALSE}
predictions <- list()
predictions[["patches_1"]] =
  simulateForest(env = env_dt,
                 sp = Nsp,
                 # disturbance = dist_dt, this argument is optional and we will not use it for one patch
                 patches = 1,
                 height = parHeight, 
                 growthProcess = createProcess(~ 1 + env1, func = growth, initEnv = parGrowthEnv, initSpecies = parGrowth),
                 mortalityProcess = createProcess(~ 1 + env1, func = mortality, initEnv = parMortEnv, initSpecies = parMort),
                 regenerationProcess = createProcess(~ 1 + env1, func = regeneration, initEnv = parRegEnv, initSpecies = parReg),
                 debug = F
                 )

predictions[["patches_100"]] =
  simulateForest(env = env_dt,
                 sp = Nsp,
                 patches = 100,
                 disturbance = dist_dt,
                 height = parHeight, 
                 growthProcess = createProcess(~ 1 + env1, func = growth, initEnv = parGrowthEnv, initSpecies = parGrowth),
                 mortalityProcess = createProcess(~ 1 + env1, func = mortality, initEnv = parMortEnv, initSpecies = parMort),
                 regenerationProcess = createProcess(~ 1 + env1, func = regeneration, initEnv = parRegEnv, initSpecies = parReg),
                 debug = F
                 )
```

```{r plot-one-patch}
#| label: fig-charts
#| fig-cap: "Charts"
#| fig-height: 6
#| fig-width: 8
#| fig-subcap: 
#|   - "one patch"
#|   - "100 patches"
#| layout-ncol: 2

for(i in c("patches_1", "patches_100")){
  p_dat <- predictions[[i]]$long$site[, .(value = mean(value)), by = .(year, species, variable)]
  p <- ggplot(p_dat, aes(x = year, y = value, color = factor(species))) +
    geom_line() +
    theme_minimal() +
    labs(x = "Year", y = "Value") +
    coord_cartesian(ylim = c(0, NA)) +
    facet_wrap(~variable, scales = "free_y", ncol = 2, strip.position = "left", labeller = label_parsed) +
    theme(
      axis.title.y = element_blank(),
      strip.placement = "outside",
      strip.text.y.left = element_text(angle = 90)
    ) +
    guides(color = guide_legend(title = "Species", override.aes = list(linewidth = 5), ncol = 2, title.position = "top")) +
    scale_color_discrete(name = "Species")+
    ggtitle(paste0("patches = ",gsub("patches_", "", i)))
  print(p)
}
```

```{r}

```

