---
title: "Introduction-to-FINN"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction-to-FINN}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Introduction

FINN is an R-package of a forest gap model that seamlessly integrates with neural networks. The package provides various functions that allow the user to customize the model from a mechanistic forest gap model to a mostly data-driven neural network. Individual processes can be replaced by neural networks, custom functions, or a combination of both. The package is designed to be user-friendly and flexible, allowing users to easily modify the model.

# Installation

The development version of FINN can be installed from GitHub using the `devtools` package. Currently we are in a early stage of development and the package is not yet available on CRAN. If you encounter problems running the code or understanding the documentation, please let us know by opening an issue on the GitHub repository.

```{r, eval = FALSE}
devtools::install_github("https://github.com/FINNverse/FINN")
```

# Run the model

We first load the package and setup some basic simulation parameters.
```{r setup}
library(FINN)
library(data.table)
Ntimesteps = 200 # number of timesteps
Npatches = 1 # number of patches
Nsites = 1 # number of sites
```

## Species parameters

First we have to specify the species parameters. For each process species parameters are stored in vectors or matrices with rows representing species and columns representing parameters. There are two kinds of parameters 
1) process parameters like light requirements and effect of size on a process. 
2) Environmental parameters that modulate the effect of the environment on a process. Environmental parameters also include an intercept that modulates the overall effect size of a process.


The following code generates random species parameters for a simple model with 10 species and 1 environmental variable.
```{r species-parameters1}
FINN.seed(1234)
# one species
Nsp = 10 # number of species

# we draw the same shade parameters for each process for simplicity
# shade parameters correspond to the fraction of light a species needs to succesfully grow, regenerate, or survive.
shadeSP = runif(Nsp, 0.01, 0.99)

# regeneration parameters
parReg = shadeSP # regeneration is only dependent on shade and environment
parRegEnv = list(matrix(c(
  runif(Nsp, 0, 2), # intercept regulating the overall effect size
  runif(Nsp, -2, 2) # the second parameter modulates the effect of the environmental variable
  ),Nsp, 2))

# growth parameters
parGrowth = matrix(c(
  shadeSP, # see above
  runif(Nsp, 1, 2) # the second growth parameter modulates the size dependent growth
  ),Nsp, 2) 

parGrowthEnv = list(matrix(c(
  runif(Nsp, -1, 1), # intercept regulating the overall effect size
  runif(Nsp, -1, 1) # the second parameter modulates the effect of the environmental variable
  ),Nsp, 2))

# mortality parameters
parMort = matrix(c(
  shadeSP, # see above
  runif(Nsp, 1, 4) # the second growth parameter modulates the size dependent mortality
  ),Nsp, 2)
parMortEnv = list(matrix(c(
  runif(Nsp, 0, 0.5), # intercept regulating the overall effect size
  runif(Nsp, 0, .5) # the second parameter modulates the effect of the environmental variable
  ), Nsp, 2))

# allometric parameters for the calculation of tree height from a trees diameter
parHeight = runif(Nsp, 0.3, 0.7)
```

## Environmental input variables

Next we have to specify the environmental input variables. These variables are used to calculate the effect of the environment on the processes. The environmental variables are supplied with a data.frame/data.table in a long format with the columns siteID and year and the environmental variables as additional columns.

```{r environmental-input}
# we first generate a data.table with all combinations of site and timestep.
env_dt <- data.table(
  expand.grid(
    list(
      siteID = 1:Nsites,
      year = 1:Ntimesteps
    )
  )
)

# for this very simple model we will have a constant environment for all sites and timesteps
env_dt$env1 = rep(0, Ntimesteps)
```

## Simulate on one patch

```{r simulate}
  system.time({
    predictions =
      simulateForest(env = env_dt,
                     sp = Nsp,
                     patches=Npatches,
                     height =parHeight, 
                     growthProcess = createProcess(~1+env1, func = growth, initEnv = parGrowthEnv, initSpecies = parGrowth),
                     mortalityProcess = createProcess(~1+env1, func = mortality, initEnv = parMortEnv, initSpecies = parMort),
                     regenerationProcess = createProcess(~1+env1, func = regeneration, initEnv = parRegEnv, initSpecies = parReg),
                     device = "cpu", debug = F)
  })

```

```{r plot}
library(ggplot2)
preds = predictions$long$site
ggplot(preds[, .(value = mean(value)), by = .(year, species, variable)],
       aes(x = year, y = value, color = factor(species))) +
  geom_line() +
  labs(x = "Year", y = "Value") +
  theme_minimal() +
  coord_cartesian(ylim = c(0, NA), xlim = c(0,200)) +
  scale_color_discrete(name = "Species")+
  facet_wrap(~variable, scales = "free_y", ncol = 1, strip.position = "left") +
  theme(axis.title.y = element_blank(),
    strip.placement = "outside",  # Places the facet labels outside the plotting area
    strip.text.y.left = element_text(angle = 90)  # Ensures the facet labels are horizontal
  )

````


